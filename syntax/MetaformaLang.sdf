module MetaformaLang

imports 
	Common
	Exp
	lexical/MetaformaLang-Identifiers

exports

sorts	Group MetaClass

  context-free start-symbols
  
    Start
 
  context-free syntax
  %% Definition:  INDIRECT code generation
  %% Declaration: DIRECT code generation
  
   "program" ID Definition* Declaration*						-> Start {"Program"}
   %%ModuleDef GroupDef* Definition 						-> Start {"Start", scope(Include)}
    
    Decl -> Definition
    
    "visualize" "{" VisGroup*"}" -> Definition {"Visualize"}
    ID "{" VisItem* "}" 		 -> VisGroup{"VisGroup"}
	
	ModHolderOrStateRef ":" Color [0-9] ";" -> VisItem{"VisItem"}
    
    ModHolderRef -> ModHolderOrStateRef
    StateRef -> ModHolderOrStateRef
    
	GroupDef 										-> Definition
	Meta "{" FieldOrPartDecl* FuncDecl* "}" 	-> Definition{"Class"}
	Module "{" FieldDecl* FuncDecl* "}" 			-> Definition{"Class"}
	
	"meta" 							-> Meta{"Meta"}
	"module"						-> Module{"Module"}
	
	"void" ID "(" {ParamListElem ","}* ")" "{" Decl* Stmt* "}"					-> FuncDecl{"FuncDecl"}
	Type ID "(" {ParamListElem ","}* ")" "{" Decl* Stmt* "return" Exp ";" "}"	-> FuncDecl{"FuncDecl"}
	
	Type ID 			-> ParamListElem{"Param"}
	ID					-> Type{avoid}
	
	"packet" ID "{" PayloadDecl* "}" 					-> Declaration{"Packet"}
	FuncDecl -> Declaration

	
	%%Type {ID ","}+ ";" -> VarDecl{"VarDecl"}
	Type ID ";" -> VarDecl{"VarDecl"}
	Type ID ";" -> FieldDecl{"FieldDecl"}
	Type ID ";" -> PayloadDecl{"PayloadDecl"}
	
	FieldDecl -> FieldOrPartDecl
	"part" "[" {MetaPart ","}* "]" ";" -> FieldOrPartDecl{"MetaPartDecl"}
	ID 		-> MetaPart{"MetaPart"}
	
	ID 					-> Ref{"VarRef"}
	ID 					-> PayloadRef{"PayloadRef"}
	
	PayloadRef "=" ID			-> AssignElem{"AssignElem"}
	{AssignElem ","}*				-> AssignList{"AssignList"}
	
	"sequence" ID "{" VarDecl* FuncDecl* Instr* "}" -> Declaration{"State"}
	%% "state" ID "{" EvHdlr* TryReg* "}" -> Definition{"State"}
	
	
	EvHdlr										 -> Definition
	"when" "(" Event ")" "{" VarDecl* Stmt* "}" -> EvHdlr{"EvHdlr"}
	
	EvHdlr -> Stmt
	
	ID								-> PacketRef {"PacketRef"}
	
	"receive" "(" PacketRef ID ")" 	-> Event{"Receive"}
	Exp 							-> Event{"Event"}
	"rate" Ref						-> Rate{"Rate"}
	
	
	"to" "meta-module" -> DestSingle{"Meta"}
	"on" "connector" -> DestSingle{"Conn"}
	"to" "meta-modules" -> DestMulti{"Meta"}
	"on" "connectors" -> DestMulti{"Conn"}
	
	"send" PacketRef "(" AssignList ")"	DestSingle Exp Rate? ";"		-> Stmt{"Send"}
	"unicast" PacketRef "(" AssignList ")" DestMulti  Exp  Rate? ";" -> Stmt{"Unicast"}
	"broadcast" PacketRef "(" AssignList ")" Rate? ";" -> Stmt{"Broadcast"}
	
	
	Ref "=" Exp ";" -> Stmt{"Assign"}
	
	

	Stmt							-> Block{"Block"}
	"{" Stmt* "}" 							-> Block{"Block"}
		
	"if" "(" Exp ")" Block "else" Block 		-> Stmt{"IfElse"}
	
	"if" "(" Exp ")" Block 					-> Stmt{"If"}
		
	ID 										-> StateRef{"StateRef"}
	ID 										-> OrientRef{"OrientRef"}	
		
	Stmt -> Instr
	"goto" StateRef ";"							-> Stmt{"Goto"}
	"goto" ID "orientating" ID ";"			-> Stmt{"Goto"}
	
	"group" ID "[" {Mod ","}* "]" 			-> GroupDef{"Group"}
	"group" ID							-> GroupDef{"GroupNum"}
	
	ID 								-> Mod{"Mod"}
	
	"try" "region" StateRef "orientating" OrientRef "from" ByteList "excluding" ByteList ";" -> Stmt{"TryRegion"}
	
	 {Exp ","}* 				-> ByteList {"ByteArr"}
	
	"disconnect" "(" ModHolderRef "," ModHolderRef ")" ";"			-> Stmt{"Disconnect"}
	"connect" "(" ModHolderRef "," ModHolderRef ")" ";"			-> Stmt{"Connect"}
	"rotate" "(" ModHolderRef "," Exp ")" ";"			-> Stmt{"Rotate"}
	"rotate_continuous" "(" ModHolderRef "," Exp ")" ";"			-> Stmt{"RotateCont"}
	"disconnect_part" "(" ModHolderRef "," Exp ")" ";"			-> Stmt{"DisconnectPart"}
	"connect_part" "(" ModHolderRef "," Exp ")" ";"			-> Stmt{"ConnectPart"}
	
	"stop" "(" ModHolderRef ")" ";"			-> Stmt{"Stop"}
	
	"for" "(" Type ID ":" ID")" Block				-> Stmt{"For"}
	
	
	
	
	"wait" "(" Stop ")" ";" -> StopCondition {"Wait"}
	"until" "(" Stop ")" ";" -> StopCondition{"Until"}
	
	"consensus" "(" ")" 	-> Stop {"Consensus"}
	Exp						-> Stop	
	
	
	ID -> FuncRef{"FuncRef"}
	
	Obj "." ID -> MethodRef{"MethodRef"}
	
	
	"orientation" "matches" {OrientRef ","}* -> Exp{"OrientMatch"}
	
	
	context-free priorities
	{
	Obj "." ID 			-> Ref{"FieldRef"}
	} > {
	ID "." ID 			-> Ref{"FieldRef"}
	}
	
	context-free priorities
	{
	"@" ID										-> ModHolderRef{"ModHolderRef"}
	} > {
	ID "@" ID									-> ModHolderRef{"ModHolderRef"}
	}
	
	
	context-free priorities
	{
	"do" "{" Decl* Stmt* "}" StopCondition  -> Instr{"Instr"}
	} > {
	"do" "{" Decl* Stmt* "}" -> Instr{"Instr"}
	}
	
	
	context-free priorities
	{
	MethodRef	"(" {Exp "," }* ")" ";"  -> Stmt{"FuncCall"}
	MethodRef 	"(" {Exp "," }* ")" 	 -> Exp{"FuncCall"}
	} > {
	FuncRef  "(" {Exp "," }* ")"   			-> Exp{"FuncCall"}
	FuncRef  "(" {Exp "," }* ")" ";"			-> Stmt{"FuncCall"}
	}
	
	
	
	
	
	
	
	
	
	
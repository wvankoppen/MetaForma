program Brandt
group Clover [North,South,West,East]

sequence FlipAlong  {
	byte QUART; 
	byte HALF;
	
	module.gradientInit();
	module.gradientPropagate();
	
	do  {
		if (region.orientation matches TOP_LEFT, RIGHT_TOP, BOTTOM_RIGHT, RIGHT_BOTTOM) {
			QUART = -90;
			HALF = -180;
		}
		else {
			QUART = 90;
			HALF = 180;
		}
	} 
			
	do {		
		if (gradPri==3 && gradSec==0) module.id = West@Clover;
		if (gradPri==2 && gradSec==0) module.id = South@Clover;
		if (gradPri==3 && gradSec==1) module.id = North@Clover;
		if (gradPri==2 && gradSec==1) module.id = East@Clover;
		 module.isRef = (gradPri == 0 && gradSec == 3);
	}
			 
	
	disconnect(West@Clover,South@Clover);
	rotate(East@Clover,QUART);
	rotate(North@Clover,HALF);
	rotate(East@Clover,QUART);
	connect(North@Clover,@Floor);
	connect(West@Clover,@Floor);
	
	do {
		disconnect(East@Clover,@Floor);
		disconnect(South@Clover,@Floor);
	}
	
	rotate(East@Clover,-QUART);
	rotate(North@Clover,QUART);
	rotate(East@Clover,-QUART);
	rotate(North@Clover,QUART);
	connect(South@Clover,West@Clover);
	
	do {
		packet PacketSymmetry {	}
		
		when (receive (PacketSymmetry p)) {
			module.fixSymmetry(p.connSource,p.connDest);
		}
		if (module.isRef) {
			broadcast PacketSymmetry ();	
		}
		
	} until(consensus());
	
	module.restoreID();
	region.finish();
}

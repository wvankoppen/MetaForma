program Brandt

visualize {  
 	
 	north {
 		@Clover.North: white;
 		@Clover.South: black;
 		@Clover.West: yellow;
 		@Clover.East: green;
 		
 		@OutsideLifter: cyan;
 		@InsideLifter: magenta;
 		
 		@UpLifter.Top: yellow;
 		@UpLifter.Bottom: magenta;
 		@UpLifter.Left: green; 
 		@UpLifter.Right: yellow;
 		
 		@Dummy.Left: white;
 		@Dummy.Right: black;
 		// @InsideLifter.Top123: green;
 		// @ikbestaniet: green;
 	}
 	
 	south { 
 		Init: white; 
 		FlipOver: yellow;
 		FlipThrough: cyan;
 		FlipAlong: magenta;
 		 
 	} 
} 
  

packet MetaIdSet { 
	byte newMetaID; 
}	

packet AddNeighbor {
	byte first;
	byte second;
}

packet Gradient {
	byte prim;
	byte sec;
}

when (receive (AddNeighbor p)) {
	if (p.metaID == meta.Left) {
		meta.TopLeft = p.first; 
		meta.BottomLeft = p.second;
	}
	if (p.metaID == meta.Right) {
		meta.TopRight = p.first;
		meta.BottomRight = p.second;
	}
	if (p.metaID == meta.Top) {
		meta.TopLeft = p.first;
		meta.TopRight = p.second;
	}
	if (p.metaID == meta.Bottom) {
		meta.BottomLeft = p.first;
		meta.BottomRight = p.second;
	}
}

 
when (receive (Gradient p)) {
	if (p.pri < gradPri || p.sec < gradSec) {
		gradPri = MIN (p.pri,gradPri);
		gradSec = MIN (p.sec,gradSec);
		module.gradientPropagate();
	}	

	
 	if (p.metaID == Left) {
 		meta.TopLeft = p.first;
 		meta.BottomLeft = p.second;
 	}
}

region {
	borders [
		left: #(connSource: EAST&MALE) == 2 && #(connSource: WEST&NORTH&MALE) == 0 || #(connSource: WEST&FEMALE) == 2 && #(connSource: EAST&NORTH&FEMALE) == 0; 
		right: #(connSource: EAST&MALE) == 2 && #(connSource: WEST&NORTH&MALE) == 0 || #(connSource: WEST&FEMALE) == 2 && #(connSource: EAST&NORTH&FEMALE) == 0;
		top: #(connSource: EAST&MALE) == 2 && #(connSource: WEST&NORTH&MALE) == 0 || #(connSource: WEST&FEMALE) == 2 && #(connSource: EAST&NORTH&FEMALE) == 0;
		bottom: #(connSource: EAST&MALE) == 2 && #(connSource: WEST&NORTH&MALE) == 0 || #(connSource: WEST&FEMALE) == 2 && #(connSource: EAST&NORTH&FEMALE) == 0;
	]
}

meta {
 	part [NE, NW, SE, SW];	
	
	byte Top;
	byte Bottom;
	byte Left;
	byte Right;
	byte TopLeft;
	byte TopRight;
	byte BottomLeft; 
	byte BottomRight;

	void metaNeighborHook (byte metaID, byte destConn) {
		if (metaID != module.metaID && module.metaID != 0) {
			if (destConn == 5 || destConn == 6) {
				Right = metaID;
			}
		 	if (destConn == 2 || destConn == 7) {
		 		Top = metaID;
		 	}
			if (destConn == 0 || destConn == 3) {
				Left = metaID;
			}
			if (destConn == 1 || destConn == 4) {
				Bottom = metaID;
			}
		}
	}
 		
	void broadcastMetaNeighbors () {
		broadcastMetaNeighborsTo([Top, Bottom], Left, Right);
		broadcastMetaNeighborsTo([Left, Right], Top, Bottom);
	}



 	void broadcastMetaNeighborsTo (byte[] dests, byte v1, byte v2) {
		 unicast AddNeighbor(first = v1, second = v2) to $(metaID: dests, inRegion:false);
 	}
 	
 }



module  {
	byte gradPri;
	byte gradSec;
	boolean isRef;
	boolean sourcePri;
	boolean sourceSec;
	

	
	void gradientPropagate () {		 
		if (sourcePri){
			gradPri = 0;
		}
		
		if (sourceSec) {
			gradSec = 0;
		}
		 unicast Gradient(pri=gradPri, sec=gradSec) to $();
	}
 	

	void gradientInit() {
		sourcePri = region.atPrimaryBorder();
		sourceSec = region.atSecondaryBorder();
		
		gradPri = MAX_BYTE;
		gradSec = MAX_BYTE;			
	}
 }

                                                                                                                             



